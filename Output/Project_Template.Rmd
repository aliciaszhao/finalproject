---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Insert title of project here"
subtitle: "Web address for GitHub repository"
author: "Name"
fontsize: 12pt
mainfont: Times New Roman

---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory

# Load your packages

# Set your ggplot theme

# Load your datasets

```


# Rationale and Research Questions

In the United States, the National Ambient Air Quality Standards from the 1970 Clean Air Act help monitor air pollutant levels. While significant reductions in air pollution have been made since the standards were put in place, there are still many areas that do not meet the standards. California, in particular, has been cited as a leader in air pollution, cities such as Los Angeles-Long Beach, Bakersfield and Fresno-Madera having the highest recorded levels of ozone levels in the country. 

It is well established that exposure to higher levels of air pollutants such as ozone (O3), nitrogen dioxide (NO2), and particulate matter (PM2.5) is associated with reduced lung function, asthma exacerbations, increased hospital visits, and death (Schraufnagel et al., 2019). In fact, asthma is the leading chronic condition in children, affecting 1 in 12 children in the United States (Zahran, 2018). According to a recent Center for Disease Control and Prevention (CDC) study, children have higher rates of hospital and emergency department visits associated with asthma compared to adults (Moorman et al., 2012). The health impacts of asthma are not distributed equally among children, however. Prevalence of asthma in children can differ by age, family history, racial and ethnic group, and socioeconomic status (U.S. EPA, 2013). 

As such, my study seeks to answer two main questions:
* What are the trends of O3, NO2 and PM2.5 in some of the most polluted cities in California over a five-year period, from 2013 to 2017 ? 
* How is asthma incidence in California impacted by O3 and PM2.5 levels, accounting for socioeocnomic variables? Is this relationship different in children compared to adults? 

\newpage

# Dataset Information
Provide information on how the dataset for this analysis were collected, the data contained in the dataset, and any important pieces of information that are relevant to your analyses. This section should contain much of same information as the metadata file for the dataset but formatted in a way that is more narrative.

Describe how you wrangled your dataset in a format similar to a methods section of a journal article.

Add a table that summarizes your data structure (variables, units, ranges and/or central tendencies, data source if multiple are used, etc.). This table can be made in markdown text or inserted as a `kable` function in an R chunk. If the latter, do not include the code used to generate your table.


## EPA air quality datasets
Air quality data were collected using EPA's Download Daily Data tool (https://www.epa.gov/outdoor-air-quality-data/download-daily-data).

The following selections were made: 

Option                | Selection
--------------------- | ---------------
Pollutant             | PM2.5, Ozone, and NO2
Year                  | 2013-2017
Geographic Area       | California
Download              | Download CSV (spreadsheet)

The downloaded files, which were accessed on 2020-04-11, were saved in the project folder path `./Data/Raw/Air quality/` as `EPAair_[Pollutant]_CA_[Year]_raw.csv`. For example, the O3 dataset for 2017 was saved as `EPAair_O3_CA_2017_raw.csv`.

### PM2.5 dataset content information
This datset contains daily mean PM2.5 concentrations and the corresponding air quality index (AQI) value in California over the years 2013-2017. 

Year     | Sites  |  Counties 
---------|--------|------------
2013     | 149    |    52
2014     | 152    |    52
2015     | 151    |    52
2016     | 151    |    52
2017     | 152    |    51



### O3 dataset content information 
This dataset contains daily maximum 8-hour O3 concentrations and the corresponding air quality index (AQI) value in California over the years 2013-2017. 

Year     | Sites  |  Counties 
---------|--------|------------
2013     | 183    |    49
2014     | 182    |    49
2015     | 182    |    49
2016     | 182    |    49
2017     | 181    |    49
 

### NO2 dataset content information
This dataset contains the daily maximum 1-hour NO2 concentration and the corresponding air quality index (AQI) value in California over the years 2013-2017.

Year     | Sites  |  Counties 
---------|--------|------------
2013     | 102    |    33
2014     | 105    |    33
2015     | 108    |    33
2016     | 109    |    33
2017     | 106    |    33


All three datasets contain 20 variables (Table 2). Variable names without descriptions are self-explanatory. 

Variable                           |  Description
---------------------------------- |---------------
Date                               | Month/day/year
Source                             | AQS (Air Quality System) or AirNow
Site ID                            | A unique number within the county identifying the site.
POC                                | “Parameter Occurrence Code” used to distinguish different instruments that measure the same parameter at the same site.
Daily Mean PM2.5 Concentration     |  
Daily Max 8-hour Ozone Concentration| 
Daily Max 1-hour NO2 Concentration |
Units                              | Units for concentration
Daily_AQI_VALUE                    | Air quality index (range 0-500)
Site Name                          |
DAILY_OBS_COUNT                    | Number of observations per day
PERCENT_COMPLETE                   |
AQS_PARAMETER_CODE                 |
AQS_PARAMETER_DESC                 |
CBSA_CODE                          |
CBSA_NAME                          |
STATE_CODE                         |
STATE                              |
COUNTY_CODE                        |
COUNTY                             |
SITE_LATITUDE                      |
SITE_LONGITUDE                     |

### Data wrangling
Air quality datasets for different years were combined using `rbind` to form one dataset for each pollutant. 

The following columns were selected:
* Date
* Site.ID
* Daily.Max.1.hour.NO2.Concentration
* DAILY_AQI_VALUE
* Site.Name
* COUNTY

Additionally, columns for `Month` and `Year` were added using the `Date` column. 


## Asthma datasets
Asthma data were collected using Tracking California's Asthma Data Query tool (https://trackingcalifornia.org/asthma/query).

The following selections were made: 

Option                | Selection
--------------------- | ---------------
Type of Event         | Emergency department visits due to asthma
Age sub-group         | Age 0-17, Age 18 & over 
Year                  | 2013 - 2017
How event is measured | Age-adjusted rates per 10,000
Race/ethnicity        | All Races/Ethnicities
Gender/sex            | Both Sexes
Type of information   | Conventional
Type of geography     | Zip codes

The downloaded files, which were accessed on 2020-04-12, were saved in the project folder path `./Data/Raw/Asthma/` as `TrackingCA_Asthma_ERVisits_[Age Group]_[Year]_raw.csv`. For example, the dataset for adults in 2013 was saved as `TrackingCA_Asthma_ERVisits_Adults_2013_raw.csv`.

### Adult asthma dataset content information
This dataset contains the annual rates of asthma-related ER visits for adults in California over the years 2013-2017. 

### Children asthma dataset content information
This dataset contains the annual rates of asthma-related ER visits for children in California over the years 2013-2017. 

Both datasets contain 2 variables. Variable names without descriptions are self-explanatory. 

Variable         |  Description
-----------------|-----------------
Zip code         | 
Incidence        | Age-adjusted rate of emergency department (ER) visits due to asthma per 10,000 California residents. 

### Data wrangling
A 'Year' column was added to all asthma datasets. Datasets for 2013-2017 were combined using `rbind` to form one dataset for each age group (Adults, Children). 

Since the asthma datasets provide only zip code information but not county information, an online search was done to find zip codes and their corresponding counties in California. This information was datascraped into a data frame. This dataframe was then combined with the adult dataset and the children dataset using `left_join`. The incidence rates were then grouped by county to calculate an average incidence rate for each county. 

Finally, adult and children asthma datasets were combined using `full_join`. 

## Demographics dataset
Demographic data were collected from County Health Rankings & Roadmaps
(https://www.countyhealthrankings.org/app/california/2019/downloads).

Since demographics are assumed to remain somewhat constant over the five-year period, only one dataset was chosen. The 2019 dataset, which uses data published in 2017, was chosen.

The xls file, was accessed on 2020-04-12, was saved in the project folder path `./Data/Raw/Demographics/` as `CountyHealthRankings_CA_2019_raw.xls`. Since there multiple tabs in the xls file, relevant information from the file was taken and converted into a csv file.The csv file was saved as `CountyHealthRankings_CA_2019_filtered_raw.csv`

The following information is contained in the dataset: 
* FIPS
* State
* County
* Median Household Income
* Population
* % African American
* % Rural
* % Smokers
* % Uninsured


\newpage

# Exploratory Analysis 
## Air quality datasets

In examining the air quality index (AQI) values for the three pollutants across all sites, there is not much temporal variation (Figure 1). However, the frequency distrbution does differ depending on the pollutant. NO2 generally has lower AQI values, which are aggregate well below 50, the cut-off number for the "Good" air quality range. O3 and PM2.5 have higher AQI values, which concentrated closer to 50, and also contain more values that are above 50. 

Among the four target sites--Bakersfield, Fresno, Los Angeles and San Francisco--Bakersfield appears to have higher AQI values than the other sites across all pollutants (Figure 2). In contrast, San Francisco generally has lower AQI values compared to the other sites. Although AQI values for NO2 stay below the "Unhealthy" range for all sites, the AQI values for O3 and PM2.5 are generally in this range. 

```{r set up, include=FALSE}
# Load packages
getwd()
library(tidyverse)
library(lubridate)
library(rvest)
library(scales)
library(cowplot)
library(trend)
library(zoo)

# Upload data for NO2. 
NO2.2013 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2013_raw.csv")
NO2.2014 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2014_raw.csv")
NO2.2015 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2015_raw.csv")
NO2.2016 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2016_raw.csv")
NO2.2017 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2017_raw.csv")


# Upload data for O3. 
O3.2013 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2013_raw.csv")
O3.2014 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2014_raw.csv")
O3.2015 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2015_raw.csv")
O3.2016 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2016_raw.csv")
O3.2017 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2017_raw.csv")


# Upload data for PM2.5. 
PM25.2013 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2013_raw.csv")
PM25.2014 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2014_raw.csv")
PM25.2015 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2015_raw.csv")
PM25.2016 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2016_raw.csv")
PM25.2017 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2017_raw.csv")

# Set theme
mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right")
theme_set(mytheme)

```

```{r Data wrangling, warning=FALSE, include=FALSE}
# Combine pollution datasets by pollutant
NO2.AllYears <- rbind(NO2.2013, NO2.2014, NO2.2015, NO2.2016, NO2.2017)
O3.AllYears<- rbind(O3.2013, O3.2014, O3.2015, O3.2016, O3.2017)
PM25.AllYears<- rbind(PM25.2013, PM25.2014, PM25.2015, PM25.2016, PM25.2017)

# Format date column; Check structure, dimension, summary
NO2.AllYears$Date <- as.Date(NO2.AllYears$Date, format = "%m/%d/%Y")
dim(NO2.AllYears)
str(NO2.AllYears)
summary(NO2.AllYears)

O3.AllYears$Date <- as.Date(O3.AllYears$Date, format = "%m/%d/%Y")
dim(O3.AllYears)
str(O3.AllYears)
summary(O3.AllYears)

PM25.AllYears$Date <- as.Date(PM25.AllYears$Date, format = "%m/%d/%Y")
dim(PM25.AllYears)
str(PM25.AllYears)
summary(PM25.AllYears)

# Create column for 'Pollutant'
NO2.AllYears$Pollutant <- "NO2"
O3.AllYears$Pollutant <- "O3"
PM25.AllYears$Pollutant <- "PM2.5"

# Subset  data and create column for Year and Month; Change name of Daily.Max.1.hour.NO2.Concentration to Concentration for consistency; save file in Processed folder. 
NO2.Subset <- NO2.AllYears %>%
    select (Date, Site.ID, Daily.Max.1.hour.NO2.Concentration, DAILY_AQI_VALUE, Site.Name, COUNTY,
         COUNTY_CODE, Pollutant) %>%
  mutate (Month = month(Date)) %>%
  mutate (Year = year(Date))
names(NO2.Subset)[3] <- "Concentration"
write.csv(NO2.Subset, row.names = FALSE, 
          file ="../Data/Processed/EPAair_NO2_Processed.csv")

O3.Subset <- O3.AllYears %>%
    select (Date, Site.ID, Daily.Max.8.hour.Ozone.Concentration, DAILY_AQI_VALUE, Site.Name, COUNTY,
         COUNTY_CODE, Pollutant) %>%
  mutate (Month = month(Date)) %>%
  mutate (Year = year(Date))
names(O3.Subset)[3] <- "Concentration"
write.csv(NO2.Subset, row.names = FALSE, 
          file ="../Data/Processed/EPAair_O3_Processed.csv")

PM25.Subset <- PM25.AllYears %>%
  select(Date, Site.ID, Daily.Mean.PM2.5.Concentration, DAILY_AQI_VALUE, Site.Name, COUNTY,
         COUNTY_CODE, Pollutant) %>%
  mutate (Month = month(Date)) %>%
  mutate (Year = year(Date))
names(PM25.Subset)[3] <- "Concentration"

write.csv(PM25.Subset, row.names = FALSE, 
          file ="../Data/Processed/EPAair_PM25_Processed.csv")

# Combine subsetted datasets into one dataset for all pollutants
EPAair <- rbind(NO2.Subset, O3.Subset, PM25.Subset)
```

```{r echo=FALSE, fig.cap= "Frequency plots of daily air quality index (AQI) values for the three pollutants across the years 2013-2017.", warning=FALSE}
# Visually explore NO2 data
NO2.frequency <- ggplot(subset(EPAair, Pollutant == "NO2")) +
  geom_freqpoly(aes(x = DAILY_AQI_VALUE, color = as.factor(Year)), bins = 50) +
 labs(x = expression("Daily AQI Value for NO"[2]), color = "Year") + 
  scale_x_continuous(breaks=seq(from = 0, to = 200, by = 50), limits=c(0,200))

# Visually explore O3 data
O3.frequency <- ggplot(subset(EPAair, Pollutant == "O3")) +
  geom_freqpoly(aes(x = DAILY_AQI_VALUE, color = as.factor (Year)), bins = 50) +
  labs(x = expression("Daily AQI Value for O"[3]), color = "Year") +
  scale_x_continuous(breaks=seq(from = 0, to = 200, by = 50), limits=c(0,200))

# Visually explore PM2.5 data
PM25.frequency <- ggplot(subset(EPAair, Pollutant == "PM2.5")) +
  geom_freqpoly(aes(x = DAILY_AQI_VALUE, color = as.factor (Year)), bins = 50) +
  labs(x = "Daily AQI Value for PM2.5", color = "Year") +
  scale_x_continuous(breaks=seq(from = 0, to = 200, by = 50), limits=c(0,200))

# Combine plots 
plot_grid(NO2.frequency, O3.frequency, PM25.frequency,nrow = 3, align = 'h', axis = "b" )

```

```{r echo=FALSE, fig.cap="Boxplots of daily air quality index (AQI) values for the three pollutants in four key sites. The dashed line represents the lower bound for the `Unhealthy (For sensitive groups)` range.", warning=FALSE}
# Visualize data by target site

Airpollution.boxplot <- ggplot(subset(EPAair, Site.Name %in% c("San Francisco","Bakersfield-California",
                                                  "Los Angeles-North Main Street", "Fresno - Garland")))  +
  geom_boxplot(aes(x = Pollutant, y = DAILY_AQI_VALUE, fill=Site.Name)) +
  labs (x = "", y = "Daily AQI Value", fill = "Site") + 
  geom_hline(yintercept = 100, lty = 2) +
  theme(axis.text.x = element_text(angle = 45,  hjust = 1))
print(Airpollution.boxplot)

```


## Asthma datasets

In examining the asthma-related ER visits for adults and children across XX counties in California, children appear to have more asthma-related ER visits than adults. This is an interesting observation that will be accounted for in the GLM analysis that follows. Distributions for both age groups show a right skew. 

```{r warning=FALSE, include=FALSE}
# Upload asthma datasets for adults
Asthma.Adults.2013 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2013_raw.csv")
Asthma.Adults.2014 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2014_raw.csv")
Asthma.Adults.2015 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2015_raw.csv")
Asthma.Adults.2016 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2016_raw.csv")
Asthma.Adults.2017 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2017_raw.csv")

# Upload asthma datasets for children
Asthma.Children.2013 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2013_raw.csv")
Asthma.Children.2014 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2014_raw.csv")
Asthma.Children.2015 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2015_raw.csv")
Asthma.Children.2016 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2016_raw.csv")
Asthma.Children.2017 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2017_raw.csv")

# Add year column to all datsets
Asthma.Adults.2013$Year <- 2013
Asthma.Adults.2014$Year <- 2014
Asthma.Adults.2015$Year <- 2015
Asthma.Adults.2016$Year <- 2016
Asthma.Adults.2017$Year <- 2017

Asthma.Children.2013$Year <- 2013
Asthma.Children.2014$Year <- 2014
Asthma.Children.2015$Year <- 2015
Asthma.Children.2016$Year <- 2016
Asthma.Children.2017$Year <- 2017

# Combine adult asthma datasets, save combined file
Asthma.Adults.AllYears <- rbind(Asthma.Adults.2013, Asthma.Adults.2014, Asthma.Adults.2015, Asthma.Adults.2016,Asthma.Adults.2017)
write.csv(Asthma.Adults.AllYears, row.names = FALSE, 
          file ="../Data/Raw/TrackingCA_Asthma_ERVisits_Adults_2013to2017_raw.csv")

# Combine children asthma datasets, save combined file
Asthma.Children.AllYears <- rbind(Asthma.Children.2013, Asthma.Children.2014, Asthma.Children.2015, Asthma.Children.2016,Asthma.Children.2017)
write.csv(Asthma.Children.AllYears, row.names = FALSE, 
          file ="../Data/Raw/TrackingCA_Asthma_ERVisits_Children_2013to2017_raw.csv")

# Data scrape to get zipcodes and corresponding counties.
url <- "https://www.centralstationmarketing.com/internet-marketing/tools/zip-code-manager.html?state=CA&county=all&city="
webpage <- read_html(url)

Zip.Code <- webpage %>%
  html_nodes("tr+ tr td:nth-child(1)") %>% 
  html_text()
County <- webpage %>%
  html_nodes("tr+ tr td:nth-child(3)") %>% 
  html_text()

ZipCode.County <- data.frame(Zip.Code, County) 

# Convert zipcode to COUNTY 
str(Asthma.Adults.AllYears$Zip.Code)
Asthma.Adults.AllYears$Zip.Code <- as.character(Asthma.Adults.AllYears$Zip.Code)

Asthma.Adults.County <- Asthma.Adults.AllYears %>%
  left_join(ZipCode.County) %>%
  group_by(Year, County) %>%
  summarize (Mean.Incidence.Adults = mean(Incidence))
write.csv(Asthma.Adults.County, row.names = FALSE, 
          file ="../Data/Processed/TrackingCA_Asthma_Adults_Processed.csv")

# Combine Children asthma datasets. Convert zipcode to COUNTY 
str(Asthma.Children.AllYears$Zip.Code)
Asthma.Children.AllYears$Zip.Code <- as.character(Asthma.Children.AllYears$Zip.Code)

Asthma.Children.County <- Asthma.Children.AllYears %>%
  left_join(ZipCode.County) %>%
  group_by(Year, County) %>%
  summarize (Mean.Incidence.Children = mean(Incidence))

write.csv(Asthma.Children.County, row.names = FALSE, 
          file ="../Data/Processed/TrackingCA_Asthma_Children_Processed.csv")

# Combine children and adult asthma into one dataset 
CA.Asthma <- full_join(Asthma.Adults.County, Asthma.Children.County)
write.csv(CA.Asthma, row.names = FALSE, 
          file ="../Data/Processed/TrackingCA_Asthma_AdultsChildren_Processed.csv")
CA.Asthma.gathered <- gather(CA.Asthma, "Age.group", "Incidence", Mean.Incidence.Adults:Mean.Incidence.Children)

```


```{r echo=FALSE, fig.cap="Frequency of asthma-related ER visits of daily air quality index (AQI) values for children and adults across counties in California from 2013 to 2017.", warning=FALSE}

# Asthma frequency polygon
Asthma.frequency <- ggplot(CA.Asthma.gathered) + 
  geom_freqpoly(aes(x =Incidence, color = Age.group)) + 
  labs ( x = "Asthma-Related ER Visits Per 10,000 People") + 
  scale_color_discrete (name = "Age Group", labels = c("Adults", "Children"))
print (Asthma.frequency)
```


## Demographics dataset

In examining demographics for XX counties in California, counties generally have a low percentage of African American residents and a much higher percentage of Hispanic residents; a median household income clustering between 40,000 and 75,000; and are more rural than urban.

```{r}
Demographics <- read.csv ("../Data/Raw/Demographics/CountyHealthRankings_CA_2019_filtered_raw.csv")
```

```{r echo=FALSE, fig.cap="Frequency of median household income, percent African American, percent rural, and percent Hispanic across counties in California from 2013 to 2017.", warning=FALSE}
MHI.frequency <- ggplot(Demographics) +
  geom_freqpoly(aes(x = Median.Household.Income), bins = 15) +
  xlab("Median Household Income")

Black.freqpoly<- ggplot(Demographics) +
  geom_freqpoly(aes(x = Percent.African.American), bins = 15) +
  xlab("Percent African American")

Rural.freqpoly<- ggplot(Demographics) +
  geom_freqpoly(aes(x = Percent.Rural), bins = 15) + 
  xlab("Percent Rural")

Hispanic.freqpoly<- ggplot(Demographics) +
  geom_freqpoly(aes(x = Percent.Hispanic), bins = 15) + 
  xlab("Percent Hispanic")


# Combine frequency polygrams into one graphic. 
plot_grid(MHI.frequency, Black.freqpoly, Rural.freqpoly, Hispanic.freqpoly, nrow = 2, align = 'h', rel_heights = c(1.25, 1))



```

\newpage

# Analysis
Insert visualizations and text describing your main analyses. Format your R chunks so that graphs are displayed but code and other output is not displayed. Instead, describe the results of any statistical tests in the main text (e.g., "Variable x was significantly different among y groups (ANOVA; df = 300, F = 5.55, p < 0.0001)"). Each paragraph, accompanied by one or more visualizations, should describe the major findings and how they relate to the question and hypotheses. Divide this section into subsections, one for each research question.

Each figure should be accompanied by a caption, and each figure should be referenced within the text

## Time Series Analysis

NO2, O3 and PM2.5 were evaluated in a time series analysis for the four key sites identified in California (Figure XX). The dashed lines separate out the AQI categories into good, moderate, and unhealthy for sensitive groups. San Francisco appears to have the lowest levels of pollution, whereas O3 and PM2.5 levels for both Bakersfield and Fresno have reached the unhealthy level. 

In performing seasonal Mann-Kendall tests to these time series, it was observed that there are some trends for the pollutants beyond seasonal trends. 

For **Bakersfield**, there is a decreasing overall trend for NO2 (seasonal Mann-Kendall, z= -2.41, p value = 0.016), a decreasing overall trend for PM2.5 (seasonal Mann-Kendall, z = -3.46, p-value < 0.001) and no significant trend for O3 beyond seasonal trends over the period 2013-2017. 

For **Fresno**, there is no significant trend for NO2, O3, or PM2.5 beyond seasonal trends over the period 2013-2017. 

For **Los Angeles**, there is a no significant trend for NO2 beyond seasonal trends, an overall increasing trend for O3 (seasonal Mann-Kendall, z = 3.18, p-value =.0001), and an overall decreasing trend and a decreasing trend in April for PM2.5 ( seasonal Mann-Kendall, z = -2.05, p-value = 0.040; z = -2.205, p-value= 0.027) over the period 2013-2017.

For **San Francisco**, there is an overall decreasing trend for NO2 (seasonal Mann-Kendall, z = -2.192, p-value = 0.028), and no significant trend for O3 or PM2.5 over the period 2013-2017. 

For the most part, there is either no trend or a decreasing trend for all pollutants across the sites, which is encouraging to find. The exception is O3 in LA, which has shown an increasing trend. However, this is not too much of a concern as of now, as ozone levels are bordering moderate but mostly in the good zone. 


```{r}

# Create subset with target counties and monthly AQI data. 
EPAair.monthly <- EPAair %>%
  group_by(Year, Month, Pollutant, COUNTY, Site.Name) %>%
  na.omit() %>%
  summarise(daily.meanaqi = mean(DAILY_AQI_VALUE))

EPAair.monthly$Date <- as.Date(paste(EPAair.monthly$Year,
                                     EPAair.monthly$Month, 
                                                1, sep="-"), 
                                          format = "%Y-%m-%d")
```

```{r echo=FALSE, fig.cap="Time series analysis of monthly AQI values for NO2, O3 and PM2.5 at four key sites in California from 2013 to 2017.", warning=FALSE}
# Create datasets for each city: San Francisco, Bakersfield-California, Oakland, Los Angeles-North Main Street
EPAair.Cities <- EPAair.monthly %>%
  filter(Site.Name == "San Francisco" |
         Site.Name == "Bakersfield-California"|
         Site.Name =="Los Angeles-North Main Street"|
         Site.Name == "Fresno - Garland")

ggplot(EPAair.Cities) +
  geom_line(aes(x = Date, y = daily.meanaqi, color= Pollutant)) +
  geom_hline(yintercept = 100, lty = 2) +
  geom_hline(yintercept = 50, lty = 2) + 
  geom_text(x = as.Date("2017-05-01"), y = 45, label = "good") +
  geom_text(x = as.Date("2017-11-01"), y = 95, label = "moderate", hjust = 1) +
  geom_text(x = as.Date("2017-11-01"), y = 120, label = "unhealthy (sensitive groups)", hjust = 1) +
  labs( x="", y = "AQI value") + 
  scale_x_date(date_breaks = "1 year", date_label = "%Y") + 
  theme(axis.text.x=element_text(angle=60, hjust=1)) + 
  facet_wrap(vars(Site.Name))
```
```{r}
# Time series analysis 
# Spread data so that pollutants have their own columns

## Bakersfield 
EPAair.Bakersfield.spread <- EPAair.monthly %>%
  filter(Site.Name == "Bakersfield-California") %>%
  spread(Pollutant, daily.meanaqi) 

# Approximating missing data
EPAair.Bakersfield.spread$NO2 <- na.approx(EPAair.Bakersfield.spread$NO2)
EPAair.Bakersfield.spread$O3 <- na.approx(EPAair.Bakersfield.spread$O3)

EPAair.Bakersfield.NO2.ts <- ts(EPAair.Bakersfield.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Bakersfield.NO2.trend <- smk.test(EPAair.Bakersfield.NO2.ts)
Bakersfield.NO2.trend
summary(Bakersfield.NO2.trend)
# Significant overall decreasing trend for NO2

EPAair.Bakersfield.O3.ts <- ts(EPAair.Bakersfield.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Bakersfield.O3.trend <- smk.test(EPAair.Bakersfield.O3.ts)
Bakersfield.O3.trend
summary(Bakersfield.O3.trend)
# No significant trend for O3

EPAair.Bakersfield.PM25.ts <- ts(EPAair.Bakersfield.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Bakersfield.PM25.trend <- smk.test(EPAair.Bakersfield.PM25.ts)
Bakersfield.PM25.trend
summary(Bakersfield.PM25.trend)
# Significant overall decreasing trend for PM2.5


## Fresno
EPAair.Fresno.spread <- EPAair.monthly %>%
  filter(Site.Name == "Fresno - Garland") %>%
  spread(Pollutant, daily.meanaqi) 

EPAair.Fresno.NO2.ts <- ts(EPAair.Fresno.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Fresno.NO2.trend <- smk.test(EPAair.Fresno.NO2.ts)
Fresno.NO2.trend
summary(Fresno.NO2.trend)
# No significant trend for NO2

EPAair.Fresno.O3.ts <- ts(EPAair.Fresno.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Fresno.O3.trend <- smk.test(EPAair.Fresno.O3.ts)
Fresno.O3.trend
summary(Fresno.O3.trend)
# No significant trend for O3

EPAair.Fresno.PM25.ts <- ts(EPAair.Fresno.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Fresno.PM25.trend <- smk.test(EPAair.Fresno.PM25.ts)
Fresno.PM25.trend
summary(Fresno.PM25.trend)
# No significant trend for PM2.5

## Los Angeles
EPAair.LA.spread <- EPAair.monthly %>%
  filter(Site.Name == "Los Angeles-North Main Street") %>%
  spread(Pollutant, daily.meanaqi) 

EPAair.LA.NO2.ts <- ts(EPAair.LA.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

LA.NO2.trend <- smk.test(EPAair.LA.NO2.ts)
LA.NO2.trend
summary(LA.NO2.trend)
# No significant trend for NO2

EPAair.LA.O3.ts <- ts(EPAair.LA.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

LA.O3.trend <- smk.test(EPAair.LA.O3.ts)
LA.O3.trend
summary(LA.O3.trend)
# Significant overall increasing trend for O3

EPAair.LA.PM25.ts <- ts(EPAair.LA.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

LA.PM25.trend <- smk.test(EPAair.LA.PM25.ts)
LA.PM25.trend
summary(LA.PM25.trend)
# Significant overall decreasing trend for PM2.5 and significant decreasing trned for April. 


## San Francisco
EPAair.SF.spread <- EPAair.monthly %>%
  filter(Site.Name == "San Francisco") %>%
  spread(Pollutant, daily.meanaqi) 

EPAair.SF.NO2.ts <- ts(EPAair.SF.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))
SF.NO2.trend <- smk.test(EPAair.SF.NO2.ts)
SF.NO2.trend
summary(SF.NO2.trend)
# Significatn overall decreasing trend for NO2

EPAair.SF.O3.ts <- ts(EPAair.SF.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))
SF.O3.trend <- smk.test(EPAair.SF.O3.ts)
SF.O3.trend
summary(SF.O3.trend)
# No significant trend for O3

EPAair.SF.PM25.ts <- ts(EPAair.SF.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))
SF.PM25.trend <- smk.test(EPAair.SF.PM25.ts)
SF.PM25.trend
summary(SF.PM25.trend)
# No significant trend for PM2.5
```


## General Linear Model
O3 and PM2.5 were evaluated in this general linear model analysis. NO2 was not chosen because as the exploratory analysis showed, NO2 levels are not as high as O3 and PM2.5 levels, and also there were more missing data for NO2. 



## Question 1: <insert specific question here and add additional subsections for additional questions below, if needed>

## Question 2: 




\newpage

# Summary and Conclusions

Summarize your major findings from your analyses in a few paragraphs. What conclusions do you draw from your findings? Relate your findings back to the original research questions and rationale.


\newpage

# References
<add references here if relevant, otherwise delete this section> 
