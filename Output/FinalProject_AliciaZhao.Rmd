---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Analysis of air quality and asthma data in California, 2013-2017"
subtitle: "https://github.com/aliciaszhao/finalproject"
author: "Alicia Zhao"
fontsize: 12pt
mainfont: Arial

---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
library(knitr)
```


# Rationale and Research Questions

In the United States, the National Ambient Air Quality Standards from the 1970 Clean Air Act help monitor air pollutant levels. While significant reductions in air pollution have been made since the standards were put in place, there are still many areas that do not meet the standards. California, in particular, has been cited as a leader in air pollution, with cities such as Bakersfield, Fresno, Los Angeles and San Francisco having some of the highest recorded levels of ozone levels in the country. 

From a health perspective, exposure to higher levels of air pollutants such as ozone (O3), nitrogen dioxide (NO2), and particulate matter (PM2.5) is associated with reduced lung function, asthma exacerbations, increased hospital visits, and death (Schraufnagel et al., 2019). In fact, asthma is the leading chronic condition in children, affecting 1 in 12 children in the United States (Zahran, 2018). According to a recent Center for Disease Control and Prevention (CDC) study, children have higher rates of hospital and emergency department visits associated with asthma compared to adults (Moorman et al., 2012). The health impacts of asthma are not distributed equally among children, however. Prevalence of asthma in children can differ by age, family history, racial and ethnic group, and socioeconomic status (U.S. EPA, 2013). 

As such, my study seeks to answer two main questions:

* **Question 1:** What are the trends of O3, NO2 and PM2.5 in some of the most polluted cities in California over a five-year period, from 2013 to 2017 ? 

* **Question 2:** How is asthma incidence in California impacted by O3 and PM2.5 levels, accounting for socioeconomic variables? Is this relationship different in children compared to adults? 

\newpage

# Dataset Information

## EPA air quality datasets
Air quality data were collected using [EPA's Download Daily Data tool](https://www.epa.gov/outdoor-air-quality-data/download-daily-data) (Table 1).

```{r echo=FALSE}
Table.1 <- data.frame("Option" = c("Pollutant", "Year", "Geographic Area", "Download"),
                      "Selection" = c("PM2.5, Ozone and NO2", "2013-2017", "California", 
                                      "Download CSV (spreadsheet)"))

knitr::kable(Table.1, caption = "Summary of selections made for daily air quality datasets.")
```

The downloaded files, which were accessed on 2020-04-11, were saved in the project folder path `./Data/Raw/Air quality/` as `EPAair_[Pollutant]_CA_[Year]_raw.csv`. For example, the O3 dataset for 2017 was saved as `EPAair_O3_CA_2017_raw.csv`.

### PM2.5 dataset content information
This datset contains daily mean PM2.5 concentrations and the corresponding air quality index (AQI) value in California over the years 2013-2017. 

The number of sites and counties in the dataset varied slightly by year (Table 2). 

```{r echo=FALSE}
Table.2 <- data.frame("Year" = c(2013, 2014, 2015, 2016, 2017),
                      "Sites" = c(149, 152, 151, 151, 152), 
                      "Counties" = c(52, 52, 52, 52, 51))

knitr::kable(Table.2, caption = "Summary of sites and counties for PM2.5 dataset.")
```

### O3 dataset content information 
This dataset contains daily maximum 8-hour O3 concentrations and the corresponding air quality index (AQI) value in California over the years 2013-2017. 

The number of sites and counties in the dataset varied slightly by year (Table 3). 

```{r echo=FALSE}
Table.3 <- data.frame("Year" = c(2013, 2014, 2015, 2016, 2017),
                      "Sites" = c(183, 182, 182, 182, 181), 
                      "Counties" = c(49, 49, 49, 49, 49))

knitr::kable(Table.3, caption = "Summary of sites and counties for O3 dataset.")
```

### NO2 dataset content information
This dataset contains the daily maximum 1-hour NO2 concentration and the corresponding air quality index (AQI) value in California over the years 2013-2017.

The number of sites and counties in the dataset varied slightly by year (Table 4). 

```{r echo=FALSE}
Table.4 <- data.frame("Year" = c(2013, 2014, 2015, 2016, 2017),
                      "Sites" = c(102, 105, 108, 109, 106), 
                      "Counties" = c(33, 33, 33, 33, 33))

knitr::kable(Table.4, caption = "Summary of sites and counties for NO2 dataset.")
```

All three datasets contain 20 variables (Table 5). Variable names without descriptions are self-explanatory. 

```{r echo=FALSE}
Table.5 <- data.frame("Variable" = c("Date",
                                     "Source",
                                     "Site ID",
                                     "POC",
                                     "Daily Mean PM2.5 Concentration",
                                     "Daily Max 8-hour Ozone Concentration",
                                     "Daily Max 1-hour NO2 Concentration",
                                     "Units",
                                     "Daily_AQI_Value",
                                     "Site Name",
                                     "DAILY_OBS_COUNT",
                                     "PERCENT_COMPLETE",
                                     "AQS_PARAMETER_CODE",
                                     "AQS_PARAMETER_DESC",
                                     "CBSA_CODE",
                                     "CBSA_NAME",
                                     "STATE_CODE",
                                     "STATE",
                                     "COUNTY_CODE",
                                     "COUNTY",
                                     "SITE_LATITUDE",
                                     "SITE_LONGITUDE"), 
                      "Description" = c("Month/day/year",
                                         "AQS (Air Quality System) or AirNow",
                                        "A unique number within the county identifying the site",
                                        "Parameter Occurrence Code used to distinguish different
                                        instruments that measure the same parameter at the same
                                        site", 
                                        "", 
                                        "", 
                                        "",
                                        "Units for concentration",
                                        "Air quality index (range 0-500)",
                                        "",
                                        "Number of observations per day",
                                        "",
                                        "", 
                                        "", 
                                        "The FIPS code of the metropolitan area", 
                                        "", 
                                        "The FIPS code of the state", 
                                        "", 
                                        "The FIPS code of the county",
                                        "",
                                        "",
                                        "" ))
                

knitr::kable(Table.5, caption = "Summary of variables in air quality datasets.")
```


```{r echo=FALSE}

Table.6 <- data.frame("AQI Values" = c("0-50", "51-100", "101-150", "151-200", "201-300", "301-500"),
                      "Levels of Heath Concern" = c("Good", "Moderate", "Unhealthy for Sensitive Groups",
                                                    "Unhealthy", "Very unhealthy", "Hazardous"))
                

knitr::kable(Table.6, caption = "Air quality index (AQI) values and corresponding levels of health concern.")

```


### Data wrangling
Air quality datasets for different years were combined using `rbind` to form one dataset for each pollutant. 

The following columns were selected:

* **Date**  
* **Site.ID**  
* **Daily.Max.1.hour.NO2.Concentration**  
* **DAILY_AQI_VALUE**  
* **Site.Name**  
* **COUNTY**

Additionally, columns for **Month** and **Year** were added using the **Date** column. 


## Asthma datasets
Asthma data were collected using [Tracking California's Asthma Data Query tool](https://trackingcalifornia.org/asthma/query) (Table 7).

```{r echo=FALSE}

Table.7 <- data.frame("Option" = c("Type of event", "Age sub-group", "Year", "How event is measured",
                                   "Race/ethnicity", "Gender/sex", "Type of information", "Type of geography"),
                      "Selection" = c("Emergency department visits due to asthma", "Age 0-17, AGe 18 & over", 
                                      "2013-2017", "Age-adjusted rates per 10,000", "All races/ethnicities",
                                      "Both sexes", "Conventional", "Zip codes"))

knitr::kable(Table.7, caption = "Summary of selections made for daily asthma datasets.")

```

The downloaded files, which were accessed on 2020-04-12, were saved in the project folder path `./Data/Raw/Asthma/` as `TrackingCA_Asthma_ERVisits_[Age Group]_[Year]_raw.csv`. For example, the dataset for adults in 2013 was saved as `TrackingCA_Asthma_ERVisits_Adults_2013_raw.csv`.

### Adult asthma dataset content information
This dataset contains the annual rates of asthma-related ER visits for adults in California over the years 2013-2017. 

### Children asthma dataset content information
This dataset contains the annual rates of asthma-related ER visits for children in California over the years 2013-2017. 

Both datasets contain 2 variables. Variable names without descriptions are self-explanatory. 

```{r echo=FALSE}

Table.8 <- data.frame("Variable" = c("Zip code", "Incidence"),
"Description" = c ("", "Age-adjusted rate of emergency department visits
                   due to asthma per 10,000 California residents"))

knitr::kable(Table.8, caption = "Summary of variables in asthma datasets.")

```

### Data wrangling
A **Year** column was added to all asthma datasets. Datasets for 2013-2017 were combined using `rbind` to form one dataset for each age group (Adults, Children). 

Since the asthma datasets provide only zip code information but not county information, an online search was done to find zip codes and their corresponding counties in California. This information was scraped into a data frame. This dataframe was then combined with the adult dataset and the children dataset using `left_join`. The incidence rates were then grouped by county and the average incidence rate for each county was calculated. 

Finally, adult and children asthma datasets were combined using `full_join`. 

## Demographics dataset
Demographic data were collected from [County Health Rankings & Roadmaps](https://www.countyhealthrankings.org/app/california/2019/downloads).

Since demographics are assumed to remain somewhat constant over the five-year period, only one dataset was chosen. The 2019 dataset, which uses data published in 2017, was chosen.

The xls file, was accessed on 2020-04-12, was saved in the project folder path `./Data/Raw/Demographics/` as `CountyHealthRankings_CA_2019_raw.xls`. Since there multiple tabs in the xls file, relevant information from the file was taken and converted into a csv file.The csv file was saved as `CountyHealthRankings_CA_2019_filtered_raw.csv`.

The following information is contained in the dataset:  
* **FIPS**  
* **State**  
* **County**  
* **Median Household Income**  
* **Population**  
* **Percent African American**  
* **Percent Rural**  
* **Percent Smokers**


\newpage

# Exploratory Analysis 
## Air quality datasets

```{r set up, include=FALSE}
# Load packages
getwd()
library(tidyverse)
library(lubridate)
library(rvest)
library(scales)
library(cowplot)
library(trend)
library(zoo)

# Upload data for NO2. 
NO2.2013 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2013_raw.csv")
NO2.2014 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2014_raw.csv")
NO2.2015 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2015_raw.csv")
NO2.2016 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2016_raw.csv")
NO2.2017 <- read.csv ("../Data/Raw/Air Quality/EPAair_NO2_CA_2017_raw.csv")


# Upload data for O3. 
O3.2013 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2013_raw.csv")
O3.2014 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2014_raw.csv")
O3.2015 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2015_raw.csv")
O3.2016 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2016_raw.csv")
O3.2017 <- read.csv ("../Data/Raw/Air Quality/EPAair_O3_CA_2017_raw.csv")


# Upload data for PM2.5. 
PM25.2013 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2013_raw.csv")
PM25.2014 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2014_raw.csv")
PM25.2015 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2015_raw.csv")
PM25.2016 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2016_raw.csv")
PM25.2017 <- read.csv ("../Data/Raw/Air Quality/EPAair_PM25_CA_2017_raw.csv")

# Set theme
mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "right")
theme_set(mytheme)

```

```{r Data wrangling, warning=FALSE, include=FALSE}
# Combine pollution datasets by pollutant
NO2.AllYears <- rbind(NO2.2013, NO2.2014, NO2.2015, NO2.2016, NO2.2017)
O3.AllYears<- rbind(O3.2013, O3.2014, O3.2015, O3.2016, O3.2017)
PM25.AllYears<- rbind(PM25.2013, PM25.2014, PM25.2015, PM25.2016, PM25.2017)

# Format date column; Check structure, dimension, summary
NO2.AllYears$Date <- as.Date(NO2.AllYears$Date, format = "%m/%d/%Y")
dim(NO2.AllYears)
str(NO2.AllYears)
summary(NO2.AllYears)

O3.AllYears$Date <- as.Date(O3.AllYears$Date, format = "%m/%d/%Y")
dim(O3.AllYears)
str(O3.AllYears)
summary(O3.AllYears)

PM25.AllYears$Date <- as.Date(PM25.AllYears$Date, format = "%m/%d/%Y")
dim(PM25.AllYears)
str(PM25.AllYears)
summary(PM25.AllYears)

# Create column for 'Pollutant'
NO2.AllYears$Pollutant <- "NO2"
O3.AllYears$Pollutant <- "O3"
PM25.AllYears$Pollutant <- "PM2.5"

# Subset  data and create column for Year and Month; Change name of Daily.Max.1.hour.NO2.Concentration to Concentration for consistency; save file in Processed folder. 
NO2.Subset <- NO2.AllYears %>%
    select (Date, Site.ID, Daily.Max.1.hour.NO2.Concentration, DAILY_AQI_VALUE, Site.Name, COUNTY,
         COUNTY_CODE, Pollutant) %>%
  mutate (Month = month(Date)) %>%
  mutate (Year = year(Date))
names(NO2.Subset)[3] <- "Concentration"
write.csv(NO2.Subset, row.names = FALSE, 
          file ="../Data/Processed/EPAair_NO2_Processed.csv")

O3.Subset <- O3.AllYears %>%
    select (Date, Site.ID, Daily.Max.8.hour.Ozone.Concentration, DAILY_AQI_VALUE, Site.Name, COUNTY,
         COUNTY_CODE, Pollutant) %>%
  mutate (Month = month(Date)) %>%
  mutate (Year = year(Date))
names(O3.Subset)[3] <- "Concentration"
write.csv(NO2.Subset, row.names = FALSE, 
          file ="../Data/Processed/EPAair_O3_Processed.csv")

PM25.Subset <- PM25.AllYears %>%
  select(Date, Site.ID, Daily.Mean.PM2.5.Concentration, DAILY_AQI_VALUE, Site.Name, COUNTY,
         COUNTY_CODE, Pollutant) %>%
  mutate (Month = month(Date)) %>%
  mutate (Year = year(Date))
names(PM25.Subset)[3] <- "Concentration"

write.csv(PM25.Subset, row.names = FALSE, 
          file ="../Data/Processed/EPAair_PM25_Processed.csv")

# Combine subsetted datasets into one dataset for all pollutants
EPAair <- rbind(NO2.Subset, O3.Subset, PM25.Subset)
```

In examining the air quality index (AQI) values for the three pollutants across all sites, there is not much temporal variation (Figure 1). However, the frequency distrbution does differ by pollutant. NO2 generally has lower AQI values, which aggregate well below 50, the cut-off number for the "Good" air quality range. O3 and PM2.5 have higher AQI values, which concentrate closer to 50, and also contain more values that are above 50.       

```{r echo=FALSE, fig.cap="Frequency of daily AQI values in California from 2013 to 2017.", warning=FALSE}

# Visually explore NO2 data
NO2.frequency <- ggplot(subset(EPAair, Pollutant == "NO2")) +
  geom_freqpoly(aes(x = DAILY_AQI_VALUE, color = as.factor(Year)), bins = 50) +
 labs(x = expression("Daily AQI Value for NO"[2]), color = "Year") + 
  scale_x_continuous(breaks=seq(from = 0, to = 200, by = 50), limits=c(0,200))

# Visually explore O3 data
O3.frequency <- ggplot(subset(EPAair, Pollutant == "O3")) +
  geom_freqpoly(aes(x = DAILY_AQI_VALUE, color = as.factor (Year)), bins = 50) +
  labs(x = expression("Daily AQI Value for O"[3]), color = "Year") +
  scale_x_continuous(breaks=seq(from = 0, to = 200, by = 50), limits=c(0,200))

# Visually explore PM2.5 data
PM25.frequency <- ggplot(subset(EPAair, Pollutant == "PM2.5")) +
  geom_freqpoly(aes(x = DAILY_AQI_VALUE, color = as.factor (Year)), bins = 50) +
  labs(x = "Daily AQI Value for PM2.5", color = "Year") +
  scale_x_continuous(breaks=seq(from = 0, to = 200, by = 50), limits=c(0,200))

plot_grid(NO2.frequency, O3.frequency, PM25.frequency, nrow=3)

```


\newpage

Among the four target sites (Bakersfield, Fresno, Los Angeles and San Francisco), Bakersfield appears to have higher AQI values than the other sites across all pollutants (Figure 2). In contrast, San Francisco generally has lower AQI values compared to the other sites. Although AQI values for NO2 stay below the "Unhealthy for sensitive populations" range (denoted by the dashed line) for all sites, the AQI values for O3 and PM2.5 are generally in this range. 


```{r echo=FALSE, fig.cap="Boxplots of daily AQI values in four key sites from 2013 to 2017.", warning=FALSE}
# Visualize data by target site

Airpollution.boxplot <- ggplot(subset(EPAair, Site.Name %in% c("San Francisco","Bakersfield-California",
                                                  "Los Angeles-North Main Street", "Fresno - Garland")))  +
  geom_boxplot(aes(x = Pollutant, y = DAILY_AQI_VALUE, fill=Site.Name)) +
  labs (x = "", y = "Daily AQI Value", fill = "Site") + 
  geom_hline(yintercept = 100, lty = 2) +
  theme(axis.text.x = element_text(angle = 45,  hjust = 1))

print(Airpollution.boxplot)

```

\newpage
## Asthma datasets

In examining the asthma-related ER visits for adults and children across 58 counties in California, children appear to have more asthma-related ER visits than adults (Figure 3). Distributions for both age groups show a right skew. 

```{r warning=FALSE, include=FALSE}
# Upload asthma datasets for adults
Asthma.Adults.2013 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2013_raw.csv")
Asthma.Adults.2014 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2014_raw.csv")
Asthma.Adults.2015 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2015_raw.csv")
Asthma.Adults.2016 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2016_raw.csv")
Asthma.Adults.2017 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Adults_2017_raw.csv")

# Upload asthma datasets for children
Asthma.Children.2013 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2013_raw.csv")
Asthma.Children.2014 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2014_raw.csv")
Asthma.Children.2015 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2015_raw.csv")
Asthma.Children.2016 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2016_raw.csv")
Asthma.Children.2017 <- read.csv ("../Data/Raw/Asthma/TrackingCA_Asthma_ERVisits_Children_2017_raw.csv")

# Add year column to all datsets
Asthma.Adults.2013$Year <- 2013
Asthma.Adults.2014$Year <- 2014
Asthma.Adults.2015$Year <- 2015
Asthma.Adults.2016$Year <- 2016
Asthma.Adults.2017$Year <- 2017

Asthma.Children.2013$Year <- 2013
Asthma.Children.2014$Year <- 2014
Asthma.Children.2015$Year <- 2015
Asthma.Children.2016$Year <- 2016
Asthma.Children.2017$Year <- 2017

# Combine adult asthma datasets, save combined file
Asthma.Adults.AllYears <- rbind(Asthma.Adults.2013, Asthma.Adults.2014, Asthma.Adults.2015, Asthma.Adults.2016,Asthma.Adults.2017)
write.csv(Asthma.Adults.AllYears, row.names = FALSE, 
          file ="../Data/Raw/TrackingCA_Asthma_ERVisits_Adults_2013to2017_raw.csv")

# Combine children asthma datasets, save combined file
Asthma.Children.AllYears <- rbind(Asthma.Children.2013, Asthma.Children.2014, Asthma.Children.2015, Asthma.Children.2016,Asthma.Children.2017)
write.csv(Asthma.Children.AllYears, row.names = FALSE, 
          file ="../Data/Raw/TrackingCA_Asthma_ERVisits_Children_2013to2017_raw.csv")

# Data scrape to get zipcodes and corresponding counties.
url <- "https://www.centralstationmarketing.com/internet-marketing/tools/zip-code-manager.html?state=CA&county=all&city="
webpage <- read_html(url)

Zip.Code <- webpage %>%
  html_nodes("tr+ tr td:nth-child(1)") %>% 
  html_text()
County <- webpage %>%
  html_nodes("tr+ tr td:nth-child(3)") %>% 
  html_text()

ZipCode.County <- data.frame(Zip.Code, County) 

# Convert zipcode to COUNTY 
str(Asthma.Adults.AllYears$Zip.Code)
Asthma.Adults.AllYears$Zip.Code <- as.character(Asthma.Adults.AllYears$Zip.Code)

Asthma.Adults.County <- Asthma.Adults.AllYears %>%
  left_join(ZipCode.County) %>%
  group_by(Year, County) %>%
  summarize (Mean.Incidence.Adults = mean(Incidence))
write.csv(Asthma.Adults.County, row.names = FALSE, 
          file ="../Data/Processed/TrackingCA_Asthma_Adults_Processed.csv")

# Combine Children asthma datasets. Convert zipcode to COUNTY 
str(Asthma.Children.AllYears$Zip.Code)
Asthma.Children.AllYears$Zip.Code <- as.character(Asthma.Children.AllYears$Zip.Code)

Asthma.Children.County <- Asthma.Children.AllYears %>%
  left_join(ZipCode.County) %>%
  group_by(Year, County) %>%
  summarize (Mean.Incidence.Children = mean(Incidence))

write.csv(Asthma.Children.County, row.names = FALSE, 
          file ="../Data/Processed/TrackingCA_Asthma_Children_Processed.csv")

# Combine children and adult asthma into one dataset 
CA.Asthma <- full_join(Asthma.Adults.County, Asthma.Children.County)
write.csv(CA.Asthma, row.names = FALSE, 
          file ="../Data/Processed/TrackingCA_Asthma_AdultsChildren_Processed.csv")
CA.Asthma.gathered <- gather(CA.Asthma, "Age.group", "Incidence", Mean.Incidence.Adults:Mean.Incidence.Children)

```


```{r echo=FALSE, fig.cap="Frequency of asthma-related ER visitation rates for children and adults in California from 2013 to 2017.", message=FALSE, warning=FALSE}
# Asthma frequency polygon
Asthma.frequency <- ggplot(CA.Asthma.gathered) + 
  geom_freqpoly(aes(x =Incidence, color = Age.group)) + 
  labs ( x = "Asthma-Related ER Visits Per 10,000 People") + 
  scale_color_discrete (name = "", labels = c("Adults", "Children"))
print (Asthma.frequency)
```

\newpage
## Demographics dataset

In examining demographics for 52 counties in California, counties generally have a low percentage of African American residents and a much higher percentage of Hispanic residents; a median household income clustering between 40,000 and 75,000; and more urban areas than rural areas (Figure 4).

```{r warning=FALSE, include=FALSE}
Demographics <- read.csv ("../Data/Raw/Demographics/CountyHealthRankings_CA_2019_filtered_raw.csv")
```

```{r echo=FALSE, fig.cap="Frequency of median household income, percent African American, percent rural, and percent Hispanic across counties in California from 2013 to 2017.", warning=FALSE}
MHI.frequency <- ggplot(Demographics) +
  geom_freqpoly(aes(x = Median.Household.Income), bins = 15) +
  xlab("Median Household Income")

Black.freqpoly<- ggplot(Demographics) +
  geom_freqpoly(aes(x = Percent.African.American), bins = 15) +
  xlab("Percent African American")

Rural.freqpoly<- ggplot(Demographics) +
  geom_freqpoly(aes(x = Percent.Rural), bins = 15) + 
  xlab("Percent Rural")

Hispanic.freqpoly<- ggplot(Demographics) +
  geom_freqpoly(aes(x = Percent.Hispanic), bins = 15) + 
  xlab("Percent Hispanic")


# Combine frequency polygrams into one graphic. 
plot_grid(MHI.frequency, Black.freqpoly, Rural.freqpoly, Hispanic.freqpoly, nrow = 2, align = 'h', rel_heights = c(1.25, 1))



```

\newpage

# Analysis

## Time Series Analysis

The time series analysis method was used to determine trends of O3, NO2 and PM2.5 in some of the most polluted cities in California from 2013 to 2017 (Figures 5-8). The four sites chosen were: Bakersfield, Fresno, Los Angeles and San Francisco. 

The dashed lines in the figures separate the AQI categories into **'Good'**, **'Moderate'**, and **'Unhealthy for sensitive groups'**. San Francisco appears to have the lowest levels of pollution, whereas O3 and PM2.5 levels for both Bakersfield and Fresno have reached the unhealthy level. 

In performing seasonal Mann-Kendall tests to these time series, it was observed that there are some trends for the pollutants beyond seasonal trends.


\newpage
```{r warning=FALSE, include=FALSE}

# Create subset with target counties and monthly AQI data. 
EPAair.monthly <- EPAair %>%
  group_by(Year, Month, Pollutant, COUNTY, Site.Name) %>%
  na.omit() %>%
  summarise(daily.meanaqi = mean(DAILY_AQI_VALUE))

EPAair.monthly$Date <- as.Date(paste(EPAair.monthly$Year,
                                     EPAair.monthly$Month, 
                                                1, sep="-"), 
                                          format = "%Y-%m-%d")
```

```{r warning=FALSE, include=FALSE}
# Time series analysis 
# Spread data so that pollutants have their own columns

## Bakersfield 
EPAair.Bakersfield.spread <- EPAair.monthly %>%
  filter(Site.Name == "Bakersfield-California") %>%
  spread(Pollutant, daily.meanaqi) 

# Approximating missing data
EPAair.Bakersfield.spread$NO2 <- na.approx(EPAair.Bakersfield.spread$NO2)
EPAair.Bakersfield.spread$O3 <- na.approx(EPAair.Bakersfield.spread$O3)

EPAair.Bakersfield.NO2.ts <- ts(EPAair.Bakersfield.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Bakersfield.NO2.trend <- smk.test(EPAair.Bakersfield.NO2.ts)
Bakersfield.NO2.trend
summary(Bakersfield.NO2.trend)
# Significant overall decreasing trend for NO2

EPAair.Bakersfield.O3.ts <- ts(EPAair.Bakersfield.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Bakersfield.O3.trend <- smk.test(EPAair.Bakersfield.O3.ts)
Bakersfield.O3.trend
summary(Bakersfield.O3.trend)
# No significant trend for O3

EPAair.Bakersfield.PM25.ts <- ts(EPAair.Bakersfield.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Bakersfield.PM25.trend <- smk.test(EPAair.Bakersfield.PM25.ts)
Bakersfield.PM25.trend
summary(Bakersfield.PM25.trend)
# Significant overall decreasing trend for PM2.5


## Fresno
EPAair.Fresno.spread <- EPAair.monthly %>%
  filter(Site.Name == "Fresno - Garland") %>%
  spread(Pollutant, daily.meanaqi) 

EPAair.Fresno.NO2.ts <- ts(EPAair.Fresno.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Fresno.NO2.trend <- smk.test(EPAair.Fresno.NO2.ts)
Fresno.NO2.trend
summary(Fresno.NO2.trend)
# No significant trend for NO2

EPAair.Fresno.O3.ts <- ts(EPAair.Fresno.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Fresno.O3.trend <- smk.test(EPAair.Fresno.O3.ts)
Fresno.O3.trend
summary(Fresno.O3.trend)
# No significant trend for O3

EPAair.Fresno.PM25.ts <- ts(EPAair.Fresno.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

Fresno.PM25.trend <- smk.test(EPAair.Fresno.PM25.ts)
Fresno.PM25.trend
summary(Fresno.PM25.trend)
# No significant trend for PM2.5

## Los Angeles
EPAair.LA.spread <- EPAair.monthly %>%
  filter(Site.Name == "Los Angeles-North Main Street") %>%
  spread(Pollutant, daily.meanaqi) 

EPAair.LA.NO2.ts <- ts(EPAair.LA.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

LA.NO2.trend <- smk.test(EPAair.LA.NO2.ts)
LA.NO2.trend
summary(LA.NO2.trend)
# No significant trend for NO2

EPAair.LA.O3.ts <- ts(EPAair.LA.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

LA.O3.trend <- smk.test(EPAair.LA.O3.ts)
LA.O3.trend
summary(LA.O3.trend)
# Significant overall increasing trend for O3

EPAair.LA.PM25.ts <- ts(EPAair.LA.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))

LA.PM25.trend <- smk.test(EPAair.LA.PM25.ts)
LA.PM25.trend
summary(LA.PM25.trend)
# Significant overall decreasing trend for PM2.5 and significant decreasing trned for April. 


## San Francisco
EPAair.SF.spread <- EPAair.monthly %>%
  filter(Site.Name == "San Francisco") %>%
  spread(Pollutant, daily.meanaqi) 

EPAair.SF.NO2.ts <- ts(EPAair.SF.spread$NO2, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))
SF.NO2.trend <- smk.test(EPAair.SF.NO2.ts)
SF.NO2.trend
summary(SF.NO2.trend)
# Significatn overall decreasing trend for NO2

EPAair.SF.O3.ts <- ts(EPAair.SF.spread$O3, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))
SF.O3.trend <- smk.test(EPAair.SF.O3.ts)
SF.O3.trend
summary(SF.O3.trend)
# No significant trend for O3

EPAair.SF.PM25.ts <- ts(EPAair.SF.spread$PM2.5, frequency = 12, 
                        start = c(2013, 1, 1), end = c(2017, 12, 31))
SF.PM25.trend <- smk.test(EPAair.SF.PM25.ts)
SF.PM25.trend
summary(SF.PM25.trend)
# No significant trend for PM2.5
```
### Bakersfield
There is a decreasing overall trend for NO2 (seasonal Mann-Kendall, z= -2.41, p-value = 0.016), a decreasing overall trend for PM2.5 (seasonal Mann-Kendall, z = -3.46, p-value < 0.001) and no significant trend for O3 beyond seasonal trends over the period 2013-2017. 



```{r echo=FALSE, fig.cap="Time series analysis of monthly AQI values in Bakersfield, CA from 2013 to 2017.", warning=FALSE}

Bakersfield.plot <- ggplot(subset(EPAair.monthly,Site.Name == "Bakersfield-California")) +
  geom_line(aes(x = Date, y = daily.meanaqi, color=Pollutant)) +
  geom_hline(yintercept = 100, lty = 2) +
  geom_hline(yintercept = 50, lty = 2) + 
  geom_text(x = as.Date("2017-11-01"), y = 45, label = "good", hjust=1) +
  geom_text(x = as.Date("2017-11-01"), y = 95, label = "moderate", hjust = 1) +
  geom_text(x = as.Date("2017-11-01"), y = 120, label = "unhealthy (sensitive groups)", hjust = 1) +
  labs( x="", y = "AQI value", color ="") + 
  scale_x_date(date_breaks = "1 year", date_label = "%Y") + 
  scale_color_manual(values=c("orange", "skyblue", "purple")) +
  theme(axis.text.x=element_text(angle=60, hjust=1), legend.position = "bottom")

print(Bakersfield.plot)
```

\newpage
### Fresno 
There is no significant trend for NO2, O3, or PM2.5 beyond seasonal trends over the period 2013-2017. 


```{r echo=FALSE, fig.cap="Time series analysis of monthly AQI values in Fresno, CA from 2013 to 2017.", warning=FALSE}

Fresno.plot <- ggplot(subset(EPAair.monthly,Site.Name == "Fresno - Garland")) +
  geom_line(aes(x = Date, y = daily.meanaqi, color=Pollutant)) +
  geom_hline(yintercept = 100, lty = 2) +
  geom_hline(yintercept = 50, lty = 2) + 
  geom_text(x = as.Date("2017-11-01"), y = 45, label = "good", hjust=1) +
  geom_text(x = as.Date("2017-11-01"), y = 95, label = "moderate", hjust = 1) +
  geom_text(x = as.Date("2017-11-01"), y = 120, label = "unhealthy (sensitive groups)", hjust = 1) +
  labs( x="", y = "AQI value", color="") + 
  scale_x_date(date_breaks = "1 year", date_label = "%Y") + 
  scale_color_manual(values=c("orange", "skyblue", "purple")) +
  theme(axis.text.x=element_text(angle=60, hjust=1), legend.position = "bottom")

print(Fresno.plot)

```


\newpage

### Los Angeles 
There is a no significant trend for NO2 beyond seasonal trends, an overall increasing trend for O3 (seasonal Mann-Kendall, z = 3.18, p-value =.0001), and an overall decreasing trend and a decreasing trend in April for PM2.5 ( seasonal Mann-Kendall, z = -2.05, p-value = 0.040; z = -2.205, p-value= 0.027) over the period 2013-2017.



```{r echo=FALSE, fig.cap="Time series analysis of monthly AQI values in Los Angeles, CA from 2013 to 2017.", warning=FALSE}

LA.plot <- ggplot(subset(EPAair.monthly,Site.Name == "Los Angeles-North Main Street")) +
  geom_line(aes(x = Date, y = daily.meanaqi, color=Pollutant)) +
  geom_hline(yintercept = 100, lty = 2) +
  geom_hline(yintercept = 50, lty = 2) + 
  geom_text(x = as.Date("2017-11-01"), y = 45, label = "good", hjust=1) +
  geom_text(x = as.Date("2017-11-01"), y = 95, label = "moderate", hjust = 1) +
  geom_text(x = as.Date("2017-11-01"), y = 120, label = "unhealthy (sensitive groups)", hjust = 1) +
  labs( x="", y = "AQI value", color="") + 
  scale_x_date(date_breaks = "1 year", date_label = "%Y") + 
  scale_color_manual(values=c("orange", "skyblue", "purple")) + 
  theme(axis.text.x=element_text(angle=60, hjust=1), legend.position = "bottom")

print(LA.plot)

```

\newpage
### San Francisco 
There is an overall decreasing trend for NO2 (seasonal Mann-Kendall, z = -2.192, p-value = 0.028), and no significant trend for O3 or PM2.5 over the period 2013-2017. 



```{r echo=FALSE, fig.cap="Time series analysis of monthly AQI values in San Francisco, CA from 2013 to 2017.", warning=FALSE}

SF.plot <- ggplot(subset(EPAair.monthly,Site.Name == "San Francisco")) +
  geom_line(aes(x = Date, y = daily.meanaqi, color=Pollutant)) +
  geom_hline(yintercept = 100, lty = 2) +
  geom_hline(yintercept = 50, lty = 2) + 
  geom_text(x = as.Date("2017-11-01"), y = 45, label = "good", hjust=1) +
  geom_text(x = as.Date("2017-11-01"), y = 95, label = "moderate", hjust = 1) +
  geom_text(x = as.Date("2017-11-01"), y = 120, label = "unhealthy (sensitive groups)", hjust = 1) +
  labs( x="", y = "AQI value", color="") + 
  scale_x_date(date_breaks = "1 year", date_label = "%Y") + 
  scale_color_manual(values=c("orange", "skyblue", "purple")) + 
  theme(axis.text.x=element_text(angle=60, hjust=1), legend.position = "bottom")

print(SF.plot)

```


\newpage

## General Linear Model

The general linear model (GLM) method was used to answer how asthma incidence in children and adults is impacted by O3 and PM2.5 levels and socioeconomic variables.Data were evaluated on a county-level across the years 2013 to 2017. 

### Dependent variables

The dependent variable is asthma incidence, measured by using age-adjusted asthma-related ER visitation rates per 10,000 residents. This rate was evaluated separately for adults and children. 

### Explanatory variables 

The explanatory variables are:  
* **Annual average O3 AQI value**  
* **Annual average PM2.5 AQI value**   
* **Median household income**  
* **Percent African American**  
* **Percent Hispanic**  
* **Percent rural**  
* **Percent smokers**

**O3** and **PM2.5** were included to evaluate the impact of air quality on asthma incidence. **NO2** was not chosen because as the exploratory analysis showed, NO2 levels are not as high as O3 and PM2.5 levels, and also there were more missing data for NO2.

Additionally, a few demographic variables were also evaluated. **Median household income** was chosen to account for socioeconomic factors. **Percent African American** and **Percent Hispanic** were chosen to account for racial factors. **Percent rural** was chosen to account for differences in air quality and healthcare access. **Percent smokers** was chosen to account for other health factors that could impact asthma. 


\newpage

### Asthma incidence in children

A multiple linear regression was run to predict asthma-related emergency room visitation rates in children while accounting for the explanatory variables described previously. 

The most parsimonious model includes the variables **O3**, **percent African American**, **percent Hispanic**, **percent rural** and **percent smokers** (linear regression, adjusted R2 = .66, df = 159 and p-value = <.001).

According to this model, holding all other variables constant, for every unit increase in the AQI for O3, the ER visitiation rate decreases by .67. For every percent increase in African American populations, ER visitation rate increases by 5.3. For every percent increase in Hispanic populations, the ER visitation rate increase by 1.2. For every percent increase in rural areas, the ER visitation rate increases by 1.2. For every percent increase in smokers, the ER visitations rate increases by 2.9.

```{r warning=FALSE, include=FALSE}
# Convert data to yearly data
EPAair.yearly <- EPAair %>%
  group_by(Year, Pollutant, COUNTY) %>%
  summarise(daily.meanaqi = mean(DAILY_AQI_VALUE))

colnames(EPAair.yearly)[3] = "County"

# Spread data so that pollutants have their own columns
EPAair.yearly.spread <- EPAair.yearly %>%
  spread(Pollutant, daily.meanaqi) 

# Combine air quality, asthma datasets 
CA.air.asthma <- left_join(EPAair.yearly.spread, CA.Asthma)

# Combine with demographics dataset
CA.air.asthma.demo <- left_join(CA.air.asthma, Demographics)

## Due to lack of data in NO2, will just be examining O3 and PM2.5. 
CA.air.asthma.demo <- CA.air.asthma.demo %>%
  select (-NO2)
```


```{r echo=FALSE, fig.cap="Annual average O3 AQI values, percent smokers, and asthma-related ER visitation rates for children across 52 counties in California from 2013 to 2017.", warning=FALSE}
# Preliminary visualization

O3.children.plot.smoke <-
ggplot(CA.air.asthma.demo, aes(x = O3, y = Mean.Incidence.Children)) +
  geom_point(aes(color = Percent.Smokers)) +
  geom_smooth(method = "lm") +
  scale_color_viridis_c(labels = comma) + 
  labs(x="AQI Value for O3", y = "Asthma-Related ER Visits Per 10,000 People", 
       color ="Percent Smokers") +
  theme(legend.position="bottom", text = element_text(size=10))
print(O3.children.plot.smoke)
```

```{r echo=FALSE, fig.cap="Annual average O3 AQI values, percent African American, and asthma-related ER visitation rates for children across 52 counties in California from 2013 to 2017.", warning=FALSE}

O3.children.plot.african <-
ggplot(CA.air.asthma.demo, aes(x = O3, y = Mean.Incidence.Children)) +
  geom_point(aes(color = Percent.African.American)) +
  geom_smooth(method = "lm") +
  scale_color_viridis_c(option="magma") + 
  labs(x="AQI Value for O3", y = "Asthma-Related ER Visits Per 10,000 People", 
       color ="Percent African American") + 
   theme(legend.position="bottom", text = element_text(size=10))
print(O3.children.plot.african)

```

\newpage

### Asthma incidence in adults

A multiple linear regression was run to predict asthma-related emergency room visitation rates in adults while accounting for the explanatory variables described previously. 

The most parsimonious model includes the variables **O3**, **percent African American** and **percent smokers** (linear regression, adjusted R2 =.59, df = 161, p-value <.001).

According to this model, holding all other variables constant, for every unit increase in the AQI for O3, the ER visitiation rate decreases by .41. For every percent increase in African American populations, the ER visitation rate increases by 2.4. For every percent increase in smokers, the ER visitations rate increases by 5.3.


```{r echo=FALSE, fig.cap="Annual average O3 AQI values, percent smokers, and asthma-related ER visitation rates for adults across 52 counties in California from 2013 to 2017", warning=FALSE}
O3.adults.plot.smoke <-
ggplot(CA.air.asthma.demo, aes(x = O3, y = Mean.Incidence.Adults)) +
  geom_point(aes(color = Percent.Smokers)) +
  geom_smooth(method = "lm") + 
  scale_color_viridis_c(labels = comma) + 
  labs(x="AQI Value for O3", y = "Asthma-Related ER Visits Per 10,000 People", 
       color ="Percent Smokers") + 
   theme(legend.position="bottom", text = element_text(size=10))
print(O3.adults.plot.smoke)
```

```{r echo=FALSE, fig.cap="Annual average O3 AQI values, percent African American, and asthma-related ER visitation rates for adults across 52 counties in California from 2013 to 2017", warning=FALSE}

O3.adults.plot.african <-
ggplot(CA.air.asthma.demo, aes(x = O3, y = Mean.Incidence.Adults)) +
  geom_point(aes(color = Percent.African.American)) +
  geom_smooth(method = "lm") +
  scale_color_viridis_c(option="magma") + 
  labs(x="AQI Value for O3", y = "Asthma-Related ER Visits Per 10,000 People", 
       color ="Percent African American") + 
   theme(legend.position="bottom", text = element_text(size=10))
print(O3.adults.plot.african)

```


```{r eval=FALSE, include=FALSE}
library(nlme)

CA.air.asthma.demo.naomit <- na.omit(CA.air.asthma.demo)

# Regression for children, ozone
Children.regression1 <- lm(data = CA.air.asthma.demo.naomit,
                     Mean.Incidence.Children ~ O3 + PM2.5 + Median.Household.Income
                     + Percent.African.American + Percent.Rural + Percent.Smokers +
                       Percent.Hispanic)
summary(Children.O3.regression1)

Children.O3.regression2 <- lm(data = CA.air.asthma.demo.naomit,
                     Mean.Incidence.Children ~ O3 + Percent.African.American + Percent.Rural +
                       Percent.Smokers + Percent.Hispanic)
summary(Children.O3.regression2)

# AIC
step(Children.O3.regression1)


# Regression for adults
Adults.regression1 <- lm(data = CA.air.asthma.demo.naomit,
                     Mean.Incidence.Adults ~ O3 + PM2.5 + Median.Household.Income
                     + Percent.African.American + Percent.Rural + Percent.Smokers +
                       Percent.Hispanic)
summary(Adults.regression1)

Adults.regression2 <- lm(data = CA.air.asthma.demo.naomit,
                     Mean.Incidence.Adults ~  O3 + Percent.African.American + Percent.Smokers)
summary(Adults.regression2)

# AIC
step(Adults.regression1)


## Tests
par(mfrow = c(2,2), mar=c(1,1,1,1))
plot(Children.PM25.regression)
par(mfrow = c(1,1))


library(lmtest)
library(car)
# Breush-Pagan test for homoskedasticity
lmtest::bptest(Adults.O3.PM25.regression)
lmtest::bptest(Children.O3.PM25.regression)

## VIF test for multicollinearity
car::vif (Adults.regression2)
car::vif (Children.regression2)

# AIC
step(Children.regression1)
# Original is most parsimonious for children

step(Adults.regression1)
# Original is most parsimonious for adults

```

\newpage

# Summary and Conclusions

## **Question 1:** What are the trends of O3, NO2 and PM2.5 in some of the most polluted cities in California over a five-year period, from 2013 to 2017 ? 
 
The time series analysis from this study suggest that the most part, there is either no trend or a decreasing trend for all pollutants across the sites, which is encouraging to find. The exception is O3 in LA, which has shown an increasing trend. However, this is not too much of a concern, as ozone levels are only bordering the 'Moderate' range but mostly still in the 'Good' range.
 

## **Question 2:** How is asthma incidence in California impacted by O3 and PM2.5 levels, accounting for socioeconomic variables? Is this relationship different in children compared to adults? 

Findings from this study suggest that asthma incidence in both children and adults are impacted by **O3**, **percent African Americans** and **percent smokers** in each county. However, incidence in children is more impacted by race (such as **percent African American** and **percent Hispanic**) and **percent rural** in each county when compared to incidence in adults. On the other hand, asthma incidence in adults is more sensitive to **percent smokers** in each county. 

Surprisingly, PM2.5 was not found to be a significant variable in our models. Additionally, although O3 was a significant variable, it has a slightly inverse relationship with asthma incidence, which is contrary to what was expected. One explanation is that because air pollution levels are generally in the healthy range in California, their impacts on asthma incidence are negligible when compared to the impacts of socioeconomic and racial variables. There also are likely temporal, spatial and other types of variables which were left out in the model, which can cause omitted variable bias. 

Based on our results from 2013-2017, California counties with a higher percentage of African American populations and a higher percentage of smokers are more likely to have higher asthma incidence rates in both children and adults. These results reveal that policies targeting better health outcomes may not achieve desired results by only reducing air pollution. Pre-existing disparities associated with socioeconomic and racial status may play a larger role in impacting asthma incidence, and should be addressed in conjunction with air quality policies.

\newpage

# References
Moorman JE, Akinbami LJ, Bailey CM, Zahran HS, King ME, Johnson CA, et al. National
surveillance of asthma: United States, 2001–2010. (2012). Vital Health Stat 3 (35):1–58.

Schraufnagel, D.E. et al.  (2019). Air pollution and noncommunicable diseases: a review by the
forum of International Respiratory Societies’ Environmental Committee, part 1.  Chest.
155(2), pp.409-416. 

U.S. EPA. (2013). America's Children and the Environment, Third Edition.

Zahran, H.S., Bailey, C.M., Damon, S.A., Garbe, P.L. & Breysse, P.N. Vital signs:
Asthma in children – United States, 2001-2016. (2018).  Morb Mortal. Wkly Rep. 67,
pp.149-155.


